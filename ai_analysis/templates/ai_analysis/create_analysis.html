{% extends 'ai_analysis/base.html' %}

{% block title %}创建分析 - 学生 AI 学情分析系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-plus"></i> 创建新分析
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'ai_analysis:dashboard' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> 返回仪表板
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-brain"></i> 选择分析参数
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="createAnalysisForm">
                    {% csrf_token %}

                    <div class="mb-4">
                        <label for="student_id" class="form-label">
                            <i class="fas fa-user-graduate"></i> 选择学生
                        </label>
                        <select class="form-select" id="student_id" name="student_id" required>
                            <option value="">请选择学生...</option>
                            {% for student in students %}
                            <option value="{{ student.student_id }}">
                                {{ student.name }} ({{ student.student_id }}) - {{ student.major }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">选择要进行分析的学生</div>
                    </div>

                    <div class="mb-4">
                        <label for="analysis_type" class="form-label">
                            <i class="fas fa-chart-line"></i> 分析类型
                        </label>
                        <select class="form-select" id="analysis_type" name="analysis_type" required>
                            <option value="">请选择分析类型...</option>
                            {% for type, label in analysis_types %}
                            <option value="{{ type }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">选择您希望进行的分析类型</div>
                    </div>

                    <div class="mb-4">
                        <label for="title" class="form-label">
                            <i class="fas fa-tag"></i> 分析标题
                        </label>
                        <input type="text" class="form-control" id="title" name="title"
                               placeholder="例如：张三同学的学业表现分析">
                        <div class="form-text">为此次分析起一个描述性的标题（可选）</div>
                    </div>

                    <!-- 分析类型说明 -->
                    <div class="mb-4" id="analysisDescription" style="display: none;">
                        <div class="card border-info">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-info-circle"></i> 分析说明
                                </h6>
                            </div>
                            <div class="card-body" id="descriptionContent">
                                <!-- 动态加载分析说明 -->
                            </div>
                        </div>
                    </div>

                    <!-- 数据预览 -->
                    <div class="mb-4" id="dataPreview" style="display: none;">
                        <div class="card border-secondary">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-database"></i> 数据预览
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="dataPreviewContent">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                        <p class="mt-2">正在加载学生数据...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'ai_analysis:dashboard' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> 取消
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-rocket"></i> 创建分析
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 分析类型说明模板 -->
<template id="descriptions">
    <div data-type="academic_performance">
        <h6>学业表现分析</h6>
        <p>全面分析学生的学业表现，包括：</p>
        <ul>
            <li>整体学业水平评价和排名</li>
            <li>各学科能力等级评估</li>
            <li>强势学科和弱势学科识别</li>
            <li>学习特征和模式分析</li>
            <li>关键学业指标统计</li>
        </ul>
    </div>

    <div data-type="learning_progress">
        <h6>学习进度分析</h6>
        <p>深入分析学生的学习进度，包括：</p>
        <ul>
            <li>课程学习进度和完成率</li>
            <li>学习节奏和效率评估</li>
            <li>知识掌握程度分析</li>
            <li>学习发展趋势预测</li>
            <li>潜在学习问题识别</li>
        </ul>
    </div>

    <div data-type="strength_weakness">
        <h6>优势劣势分析</h6>
        <p>使用 SWOT 分析框架评估学生，包括：</p>
        <ul>
            <li>学术优势和特长识别</li>
            <li>学习弱点和发展瓶颈</li>
            <li>发展机会和潜力分析</li>
            <li>面临的挑战和风险</li>
            <li>个性化发展建议</li>
        </ul>
    </div>

    <div data-type="improvement_suggestions">
        <h6>改进建议</h6>
        <p>提供具体可行的学习改进建议，包括：</p>
        <ul>
            <li>学习方法优化方案</li>
            <li>时间管理改进建议</li>
            <li>能力发展计划制定</li>
            <li>学习环境优化建议</li>
            <li>心理支持和激励策略</li>
        </ul>
    </div>

    <div data-type="comprehensive">
        <h6>综合分析</h6>
        <p>全方位360度学生分析，整合所有维度：</p>
        <ul>
            <li>学术能力全面评估</li>
            <li>认知特征深度分析</li>
            <li>学习行为模式识别</li>
            <li>情感态度因素评估</li>
            <li>发展潜力综合预测</li>
            <li>个性化成长路径规划</li>
        </ul>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 分析类型说明
    const descriptions = {};
    $('#descriptions > div').each(function() {
        descriptions[$(this).data('type')] = $(this).html();
    });

    // 分析类型改变时显示说明
    $('#analysis_type').change(function() {
        const type = $(this).val();
        const studentId = $('#student_id').val();

        if (type) {
            $('#descriptionContent').html(descriptions[type] || '<p>暂无说明</p>');
            $('#analysisDescription').show();

            // 如果已选择学生，加载数据预览
            if (studentId) {
                loadDataPreview(studentId, type);
            }
        } else {
            $('#analysisDescription').hide();
            $('#dataPreview').hide();
        }
    });

    // 学生选择改变时更新标题和预览
    $('#student_id').change(function() {
        const studentId = $(this).val();
        const studentName = $(this).find('option:selected').text().split(' (')[0];
        const analysisType = $('#analysis_type').val();

        // 自动填充标题
        if (studentName && !$('#title').val()) {
            const typeLabel = $('#analysis_type option:selected').text();
            $('#title').val(`${studentName}的${typeLabel}`);
        }

        // 加载数据预览
        if (analysisType && studentId) {
            loadDataPreview(studentId, analysisType);
        } else {
            $('#dataPreview').hide();
        }
    });

    // 加载数据预览
    function loadDataPreview(studentId, analysisType) {
        $('#dataPreview').show();
        $('#dataPreviewContent').html(`
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载学生数据...</p>
            </div>
        `);

        // 模拟数据预览加载（实际应用中可以调用AJAX获取真实数据）
        setTimeout(function() {
            $('#dataPreviewContent').html(`
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    系统将收集该学生的以下数据进行分析：
                </div>
                <ul class="mb-0">
                    <li>基本信息：姓名、学号、专业、学院等</li>
                    <li>成绩数据：所有课程的成绩和学分</li>
                    <li>学习记录：选课记录、学习时间等</li>
                    <li>行为数据：学习模式、进步趋势等</li>
                </ul>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt"></i>
                        所有数据仅用于本次分析，严格保护学生隐私
                    </small>
                </div>
            `);
        }, 1000);
    }

    // 表单提交
    $('#createAnalysisForm').submit(function(e) {
        const submitBtn = $('#submitBtn');
        submitBtn.prop('disabled', true);
        submitBtn.html('<i class="fas fa-spinner fa-spin"></i> 创建中...');
    });
});
</script>
{% endblock %}