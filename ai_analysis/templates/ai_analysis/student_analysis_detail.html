<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生学情分析详情 - {{ student.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card { border: none; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .score-excellent { color: #28a745; }
        .score-good { color: #20c997; }
        .score-average { color: #ffc107; }
        .score-pass { color: #fd7e14; }
        .score-fail { color: #dc3545; }
        .analysis-card { border-left: 4px solid #007bff; }
        .student-avatar { width: 60px; height: 60px; border-radius: 50%; background: #007bff; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- 学生信息头部 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="student-avatar me-4">
                                {{ student.name.0 }}
                            </div>
                            <div class="flex-grow-1">
                                <h2 class="mb-1">{{ student.name }}</h2>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-id-card me-2"></i>{{ student.student_id }}
                                    <i class="fas fa-university ms-3 me-2"></i>{{ student.major }}
                                    <i class="fas fa-graduation-cap ms-3 me-2"></i>{{ student.college }}
                                </p>
                                <p class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>平均成绩: <strong>{{ avg_score }}</strong> 分
                                    <i class="fas fa-book ms-3 me-2"></i>总课程: <strong>{{ course_count }}</strong> 门
                                </p>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-primary" onclick="generateNewAnalysis()">
                                    <i class="fas fa-plus me-2"></i>生成新分析
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card stat-card border-left-primary">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="text-uppercase text-muted mb-0">平均成绩</h5>
                                <h2 class="mb-0 font-weight-bold text-primary">{{ avg_score }}</h2>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-chart-line fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card stat-card border-left-success">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="text-uppercase text-muted mb-0">通过课程</h5>
                                <h2 class="mb-0 font-weight-bold text-success">{{ course_count|add:"-"|add:failed_courses }}</h2>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check-circle fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card stat-card border-left-danger">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="text-uppercase text-muted mb-0">挂科课程</h5>
                                <h2 class="mb-0 font-weight-bold text-danger">{{ failed_courses }}</h2>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-times-circle fa-2x text-danger"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card stat-card border-left-warning">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="text-uppercase text-muted mb-0">优秀课程</h5>
                                <h2 class="mb-0 font-weight-bold text-warning">{{ excellent_courses }}</h2>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-trophy fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 成绩分布和课程统计 -->
        <div class="row mb-4">
            <!-- 成绩分布 -->
            <div class="col-xl-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0">
                            <i class="fas fa-chart-pie me-2"></i>成绩分布
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="scoreDistributionChart" height="250"></canvas>
                        <div class="row mt-3 text-center">
                            <div class="col-md-2">
                                <div class="score-excellent">
                                    <i class="fas fa-circle"></i> 优秀 (90+)
                                    <h5>{{ score_distribution.excellent }}</h5>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="score-good">
                                    <i class="fas fa-circle"></i> 良好 (80-89)
                                    <h5>{{ score_distribution.good }}</h5>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="score-average">
                                    <i class="fas fa-circle"></i> 中等 (70-79)
                                    <h5>{{ score_distribution.average }}</h5>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="score-pass">
                                    <i class="fas fa-circle"></i> 及格 (60-69)
                                    <h5>{{ score_distribution.pass }}</h5>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="score-fail">
                                    <i class="fas fa-circle"></i> 不及格 (<60)
                                    <h5>{{ score_distribution.fail }}</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI分析历史 -->
            <div class="col-xl-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0">
                            <i class="fas fa-history me-2"></i>AI分析历史
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for analysis in analyses %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">
                                            {% if analysis.analysis_type == 'academic' %}学业成绩分析
                                            {% elif analysis.analysis_type == 'progress' %}学习进步分析
                                            {% elif analysis.analysis_type == 'strength' %}优势特长分析
                                            {% elif analysis.analysis_type == 'improvement' %}改进建议分析
                                            {% else %}综合分析
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted">{{ analysis.created_at|date:"Y-m-d H:i" }}</small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-success">{{ analysis.status }}</span>
                                        {% if analysis.ai_confidence %}
                                        <span class="badge bg-info">置信度: {{ analysis.ai_confidence }}%</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if analysis.analysis_result %}
                                <div class="mt-2">
                                    <p class="mb-0 small">{{ analysis.analysis_result|truncatechars:150 }}</p>
                                </div>
                                {% endif %}
                            </div>
                            {% empty %}
                            <p class="text-muted text-center py-4">暂无分析记录</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 详细分析报告 -->
        {% if analyses %}
        <div class="row">
            <div class="col-12">
                <div class="card analysis-card">
                    <div class="card-header">
                        <h6 class="m-0">
                            <i class="fas fa-robot me-2"></i>最新AI分析报告
                        </h6>
                    </div>
                    <div class="card-body">
                        {% for analysis in analyses %}
                        {% if forloop.counter0 == 0 %}
                        <div class="analysis-item mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    {% if analysis.analysis_type == 'academic' %}学业成绩分析
                                    {% elif analysis.analysis_type == 'progress' %}学习进步分析
                                    {% elif analysis.analysis_type == 'strength' %}优势特长分析
                                    {% elif analysis.analysis_type == 'improvement' %}改进建议分析
                                    {% else %}综合分析
                                    {% endif %}
                                </h5>
                                <div>
                                    <span class="badge bg-primary">{{ analysis.get_analysis_type_display }}</span>
                                    <span class="badge bg-success">{{ analysis.created_at|date:"Y-m-d H:i" }}</span>
                                </div>
                            </div>

                            {% if analysis.analysis_result %}
                            <div class="analysis-content">
                                <p class="lead">{{ analysis.title }}</p>
                                <div class="analysis-result">
                                    {{ analysis.analysis_result|linebreaks }}
                                </div>

                                {% if analysis.ai_confidence %}
                                <div class="mt-3">
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar {% if analysis.ai_confidence >= 80 %}bg-success{% elif analysis.ai_confidence >= 60 %}bg-warning{% else %}bg-danger{% endif %}"
                                             style="width: {{ analysis.ai_confidence }}%">
                                            AI置信度: {{ analysis.ai_confidence }}%
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 成绩分布图表
        const scoreCtx = document.getElementById('scoreDistributionChart').getContext('2d');
        new Chart(scoreCtx, {
            type: 'doughnut',
            data: {
                labels: ['优秀 (90+)', '良好 (80-89)', '中等 (70-79)', '及格 (60-69)', '不及格 (<60)'],
                datasets: [{
                    data: [
                        {{ score_distribution.excellent }},
                        {{ score_distribution.good }},
                        {{ score_distribution.average }},
                        {{ score_distribution.pass }},
                        {{ score_distribution.fail }}
                    ],
                    backgroundColor: [
                        '#28a745',
                        '#20c997',
                        '#ffc107',
                        '#fd7e14',
                        '#dc3545'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        function generateNewAnalysis() {
            // 这里可以添加生成新分析的功能
            alert('生成新分析功能开发中...');
        }
    </script>
</body>
</html>