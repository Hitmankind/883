<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 学情分析仪表板</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card { border: none; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); }
        .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .alert-custom { border-left: 4px solid #007bff; }
        .student-avatar { width: 40px; height: 40px; border-radius: 50%; background: #007bff; color: white; display: flex; align-items: center; justify-content: center; }
        .analysis-type-badge { font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- 头部 -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="h2 mb-0">
                    <i class="fas fa-brain text-primary"></i> AI 学情分析仪表板
                </h1>
                <p class="text-muted">智能分析学生学业表现，提供个性化建议</p>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stat-card border-left-primary">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="text-uppercase text-muted mb-0">总学生数</h5>
                                <h2 class="mb-0 font-weight-bold text-primary">{{ total_students }}</h2>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-users fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stat-card border-left-success">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="text-uppercase text-muted mb-0">已完成分析</h5>
                                <h2 class="mb-0 font-weight-bold text-success">{{ completed_analyses }}</h2>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check-circle fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stat-card border-left-warning">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="text-uppercase text-muted mb-0">待处理分析</h5>
                                <h2 class="mb-0 font-weight-bold text-warning">{{ pending_analyses }}</h2>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clock fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stat-card border-left-info">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="text-uppercase text-muted mb-0">分析成功率</h5>
                                <h2 class="mb-0 font-weight-bold text-info">{{ ai_stats.success_rate }}%</h2>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-chart-line fa-2x text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表和详情 -->
        <div class="row">
            <!-- 学业趋势图 -->
            <div class="col-xl-8 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0">
                            <i class="fas fa-chart-line me-2"></i>学业成绩趋势
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- AI 服务统计 -->
            <div class="col-xl-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0">
                            <i class="fas fa-robot me-2"></i>AI 服务状态
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">总请求数</span>
                                <span class="badge bg-primary">{{ ai_stats.total_requests }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">成功率</span>
                                <span class="badge bg-success">{{ ai_stats.success_rate }}%</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">平均响应时间</span>
                                <span class="badge bg-info">{{ ai_stats.avg_response_time }}s</span>
                            </div>
                        </div>
                        <hr>
                        <h6 class="text-muted mb-3">最近7天请求量</h6>
                        <canvas id="requestChart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分析类型分布和最近分析 -->
        <div class="row">
            <!-- 分析类型分布 -->
            <div class="col-xl-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0">
                            <i class="fas fa-pie-chart me-2"></i>分析类型分布
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="analysisTypeChart" height="250"></canvas>
                    </div>
                </div>
            </div>

            <!-- 最近分析记录 -->
            <div class="col-xl-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0">
                            <i class="fas fa-history me-2"></i>最近分析记录
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for analysis in recent_analyses %}
                            <div class="list-group-item px-0">
                                <div class="d-flex align-items-center">
                                    <div class="student-avatar me-3">
                                        {{ analysis.student.name.0 }}
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">{{ analysis.student.name }}</h6>
                                            <span class="badge analysis-type-badge bg-primary">
                                                {% if analysis.analysis_type == 'academic' %}学业成绩分析
                                                {% elif analysis.analysis_type == 'progress' %}学习进步分析
                                                {% elif analysis.analysis_type == 'strength' %}优势特长分析
                                                {% elif analysis.analysis_type == 'improvement' %}改进建议分析
                                                {% else %}综合分析
                                                {% endif %}
                                            </span>
                                        </div>
                                        <small class="text-muted">{{ analysis.created_at|date:"m-d H:i" }}</small>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-muted text-center py-4">暂无分析记录</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 问题学生和优秀学生 -->
        <div class="row">
            <!-- 问题学生 -->
            <div class="col-xl-6 mb-4">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="m-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>需要关注的学生
                        </h6>
                    </div>
                    <div class="card-body">
                        {% for student in problem_students %}
                        <div class="alert alert-custom alert-warning mb-3">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>{{ student.student.name }}</strong>
                                    <small class="text-muted d-block">{{ student.student.student_id }} - {{ student.student.major }}</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">{{ student.created_at|date:"m-d" }}</small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted text-center py-3">暂无需要关注的学生</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- 优秀学生 -->
            <div class="col-xl-6 mb-4">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="m-0">
                            <i class="fas fa-trophy me-2"></i>表现优秀的学生
                        </h6>
                    </div>
                    <div class="card-body">
                        {% for student in excellent_students %}
                        <div class="alert alert-custom alert-success mb-3">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>{{ student.student.name }}</strong>
                                    <small class="text-muted d-block">{{ student.student.student_id }} - {{ student.student.major }}</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">{{ student.created_at|date:"m-d" }}</small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted text-center py-3">暂无优秀学生记录</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Chart.js 默认配置
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';

        // 学业趋势图
        const performanceCtx = document.getElementById('performanceChart').getContext('2d');
        const performanceData = {{ performance_trend|safe }};

        new Chart(performanceCtx, {
            type: 'line',
            data: {
                labels: performanceData.map(d => d.month),
                datasets: [{
                    label: '平均成绩',
                    data: performanceData.map(d => d.avg_score),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 50,
                        max: 100
                    }
                }
            }
        });

        // 请求量图表
        const requestCtx = document.getElementById('requestChart').getContext('2d');
        const requestData = {{ ai_stats.daily_requests|safe }};

        new Chart(requestCtx, {
            type: 'bar',
            data: {
                labels: requestData.map(d => d.date),
                datasets: [{
                    label: '请求量',
                    data: requestData.map(d => d.count),
                    backgroundColor: 'rgba(54, 162, 235, 0.8)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // 分析类型分布图
        const analysisTypeCtx = document.getElementById('analysisTypeChart').getContext('2d');
        const analysisTypeData = {{ analysis_types|safe }};

        new Chart(analysisTypeCtx, {
            type: 'doughnut',
            data: {
                labels: analysisTypeData.map(d => analysis_types_dict[d.analysis_type]),
                datasets: [{
                    data: analysisTypeData.map(d => d.count),
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // 自动刷新数据
        setInterval(() => {
            fetch('/ai/ajax?action=get_analysis_count')
                .then(response => response.json())
                .then(data => {
                    // 更新统计卡片
                    document.querySelector('.border-primary h2').textContent = data.total;
                    document.querySelector('.border-success h2').textContent = data.completed;
                    document.querySelector('.border-warning h2').textContent = data.pending;
                });
        }, 30000); // 每30秒刷新一次
    </script>
</body>
</html>